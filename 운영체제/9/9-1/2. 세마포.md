# 세마포 (216p)

- 정의 

    > 세마포로 사용되는 변수 S는 정수형 변수로서, 초기화를 제외하고는 단지 두 개의 표준 연산으로만 접근한다.
    > 두 연산은 '검사하다'는 뜻의 네덜란드어 Proberen의 머리글자 P와, '증가하다'라는 뜻의 단어 Verhogen에서 V라고 명명되었다.

        P(S) {

            whlie S <= 0;
            
            S--;

        }

        V(S) {

            S++;

        }

    > P와 V연산 시 세마포의 정수 값을 변경하는 연산은 TestAndSet과 같이 원자적(분리되지 않는)으로 수행한다.


- 세마포를 이용한 상호 배제

    > 세마포를 이용한 N개의 프로세스의 상호배제 구현

        semaphore S = 1;

        while (1) {

            P(S);

            // 임계 구역

            ....

            V(S);

        }


- 세마포를 이용한 동기화

    > 한 프로세스는 특정 사건이 일어나기를 기다리고(블록 상태) 다른 프로세스는 특정 사건이 발생했음을 알려준다.

    > s는 공유 변수이다.


        semaphore s = 0;


            > wakeup 시킬 프로세스

            ......

            V(s);

            ......


            > block될 프로세스

            ......

            P(s);
            ......

    > s가 0으로 초기화되었기 때문에 블록될 프로세스는 P(s) 연산을 수행할 수 없고, wakeup시킬 프로세스가 V(s)연산을 실행한 후에 수행될 수 있다.


- 세마포를 이용한 생산자 / 소비자 문제

    > n개의 데이터를 저장할 수 있는 일반적인 생산자 / 소비자 문제

    > 공유 변수     

        > semaphore mutex = 1;

        > semaphore empty = n;

        > semaphore full = 0;

    > mutex는 상호 배제를 위한 세마포이고, empty는 버퍼에 비어 있는 항목의 개수이며, full은 버퍼에 채워져 있는 데이터의 개수를 나타낸다.


    ex) 생산자 프로세스


        while(1) {

            // 데이터 생산

            P(empty);

            P(mutex);

            // 생산된 데이터를 버퍼에 추가

            V(mutex);

            V(full);

        }


    ex) 소비자 프로세스

        while(1) {

            P(full);

            P(mutex);

            // 버퍼에서 데이터 제거

            V(mutex);

            V(empty);

            // 제거된 데이터 전송

        }


- 세마포를 이용한 읽기 / 쓰기 문제

    > 여러 개의 읽기 프로세스가 동시에 공유 자료에 접근하는 것은 허용된다.

    > 읽기 프로세스와 쓰기 프로세스가 동시에 접근하는 것은 허용되지 않는다.

    > 여러 개의 쓰기 프로세스도 동시에 공유 자료에 접근을 할 수 없다.

    > 알고리즘에서 사용되는 데이터

        > semaphore wrt = 1;

        > semaphore mutex = 1;

        > int readcount = 0;

    > wrt는 쓰기 프로세스 접근 시 배타적 사용을 위한 세마포이며, readcount는 읽기 프로세스의 개수를 나타내며 초깃값은 0으로 설정된다.

    
    ex) 쓰기 프로세스

        P(wrt);

            // 쓰기 실행

        V(wrt);


    ex) 읽기 프로세스

        P(mutex);

            readcount++;

            if (readcount == 1) P(wrt);

        V(mutex);

            // 읽기 수행

        P(mutex);

            readcount==;

            if (readcount == 0) V(wrt);

        V(mutex);


- 자바 세마포

    > 스레드들 간에 신호를 보내기 위하여 또는 임계 구역을 보호하기 위하여 사용될 수 있는 스레드 동기화 구조이다.

    > java.util.concurrent 패키지에 세마포 구현이 포함되어 있다.

    > 자바 세마포 클래스 생성자는 한 번에 공유 자원을 엑세스 할 수 있는 스레드 개수를 지정하는 정수형 매개 변수를 갖는다.

    > 세마포 클래스는 잠금을 얻고 해제하는데 사용되는 2가지 메소드( acquire(), release() )가 있다.

        - 세마포를 사용하여 자원에 대한 엑세스를 잠글 수 있으며, 자원을 사용하려는 스레드는 먼저 자원 엑세스에 대한 잠금을 획득하기 위하여 acquire()를 호출한다.

        - 스레드가 완료되면 release() 메서드를 호출ㄹ하여 자원에 대한 잠금을 해제한다.